<html>
<head>
<script src="https://jonudell.info/hlib/hlib.js"></script>
<script src="https://jonudell.info/hlib/jsonTree.js"></script>
<link rel="stylesheet" href="https://jonudell.info/hlib/jsonTree.css">
<link rel="stylesheet" href="https://jonudell.info/hlib/hlib.css">
<style>

body {
  display: flex;
}

#formContainer {
  display: flex;
  flex-direction: column;
}

.jsontree_value-wrapper { 
  overflow: hidden;
}

ul  { 
  list-style-type: none;
}

</style>
</head>
<body>

<div id="formContainer">
  <div class="formField" id="groupContainer"></div>
  <div class="formField" id="tokenContainer"></div>
  <div class="formField">
    <button onclick="search()">search</button>
  </div>
</div>

<div id="viewer"/>

<script>

function incrementBy(object, property, amount) {
  if ( isNaN(object[property])) {
    object[property] = amount;
  }
  else {
    object[property] += amount;
  }
}

function findElements(text, pattern) {
  var match;
  var count = 0;
  while ( (match = pattern.exec(text)) != null ) {
    count += 1;
  }
  return count;
}

function mean(numbers) {
    var total = 0, i;
    for (i = 0; i < numbers.length; i += 1) {
        total += numbers[i];
    }
    return total / numbers.length;
}

function truncateFloat(flt) {
  return parseFloat(flt.toFixed(1));  
}

function activateUrls() {
  var urls = document.querySelectorAll('.jsontree_value_string');
  urls.forEach(function(url) {
    var linkText = url.innerHTML.replace(/"/g,'');
    var labelText = decodeURIComponent(/url=([^&]+)/.exec(linkText)[1]);
    url.innerHTML = `<a target="_new" href="${linkText}">${labelText}</a>`;
  })
}

function median(numbers) {
    // median of [3, 5, 4, 4, 1, 1, 2, 3] = 3
    var median = 0, numsLen = numbers.length;
    numbers.sort();
 
    if (
        numsLen % 2 === 0 // is even
    ) {
        // average of two middle numbers
        median = (numbers[numsLen / 2 - 1] + numbers[numsLen / 2]) / 2;
    } else { // is odd
        // middle number only
        median = numbers[(numsLen - 1) / 2];
    }
 
    return median;
}

function processAnno(anno, data){ 
  var linkPattern = /\[[^]*\(http[^\)]+\)/g;
  var imagePattern = /\[\]\([^\)]+\)/g;
  var directLinkPattern = /https:\/\/hyp.is/g;

  anno = parseAnnotation(anno);

  if (! data.data[anno.user]) {
    data.data[anno.user] = {};
    data.data[anno.user]['urls'] = [];
    data.data[anno.user]['quoteLengths'] = [];
    data.data[anno.user]['annotationLengths'] = [];
    data.data[anno.user]['replyLengths'] = [];
  }

  var studentRecord = data.data[anno.user];

  if ( studentRecord.urls.indexOf(anno.url) === -1 ) {
    studentRecord.urls.push(anno.url);
    incrementBy(studentRecord, 'urlsAnnotated', 1);
  }

  if (! anno.refs.length) {
    incrementBy(studentRecord, 'annotations', 1);
  }
  else {
    incrementBy(studentRecord, 'replies', 1);
  }

  var quoteLength = anno.quote.length;
  incrementBy(studentRecord, 'quoteLength', anno.quote.length);
  studentRecord.quoteLengths.push(quoteLength);

  if ( anno.isReply ) {
    var replyLength = anno.text.length;
    incrementBy(studentRecord, 'replyLength', anno.text.length);
    studentRecord.replyLengths.push(replyLength);
  } else {
    var annotationLength = anno.text.length;
    incrementBy(studentRecord, 'annotationLength', anno.text.length);
    studentRecord.annotationLengths.push(annotationLength);
  }

  incrementBy(studentRecord, 'tagCount', anno.tags.length);

  var imageCount = findElements(anno.text, imagePattern);
  incrementBy(studentRecord, 'imageCount', imageCount);

  var directLinkCount = findElements(anno.text, directLinkPattern);
  incrementBy(studentRecord, 'directLinkCount', directLinkCount);

  var linkCount = findElements(anno.text, linkPattern)
  incrementBy(studentRecord, 'linkCount', linkCount);

  data.data[anno.user] = studentRecord;
 
  return data;
}

function compileData(annos) {
  var data = {
    data: {},
    quoteLengths: {},
    annotationLengths: {},
    replyLengths: {},
}  
  annos.forEach(function(anno) {
    data = Object.assign(data, processAnno(anno, data));
  });

  Object.keys(data.data).forEach(function(student) {

    var studentRecord = data.data[student];

    var urls = data.data[student].urls.map(function(url) {
      var escapedUrl = encodeURIComponent(url);
      return `https://hyp.is/go?url=${escapedUrl}&q=user:${student}`;
    });

    studentRecord.urls = urls.sort();

    var quoteLength = studentRecord.quoteLength;
    var quoteLengths = studentRecord.quoteLengths;

    var annotationLength = studentRecord.annotationLength;
    var annotationLengths = studentRecord.annotationLengths;

    var replyLength = studentRecord.replyLength;
    var replyLengths = studentRecord.replyLengths;

    studentRecord.ratioAnnotationLengthToQuoteLength = 
      truncateFloat(annotationLength / quoteLength);

    studentRecord.meanQuoteLength = truncateFloat(mean(quoteLengths));
    studentRecord.medianQuoteLength = truncateFloat(median(quoteLengths));

    studentRecord.meanAnnotationLength = truncateFloat(mean(annotationLengths));
    studentRecord.medianAnnotationLength = truncateFloat(median(annotationLengths));

    if ( replyLengths.length ) {
      studentRecord.meanReplyLength = truncateFloat(mean(replyLengths));
      studentRecord.medianReplyLength = truncateFloat(median(replyLengths));
    }

    delete studentRecord.quoteLengths;
    delete studentRecord.annotationLengths;
    delete studentRecord.replyLengths;

  });


  json = data.data;

  var viewer = document.getElementById("viewer");

  var tree = jsonTree.create(json, viewer);

  tree.expand(function(node) {
   return node;
  });

  activateUrls();
}

function search() {
  document.getElementById("viewer").innerHTML = '';
  var group = getSelectedGroup();
  hApiSearch({group: group}, processSearchResults);
}

function processSearchResults(annos, replies) {
    compileData(annos.concat(replies));
}

var tokenContainer = getById('tokenContainer');
createApiTokenInputForm(tokenContainer);

var groupContainer = getById('groupContainer');
createGroupInputForm(groupContainer);

</script>  

</body>
</html>
